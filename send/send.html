<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç æ–‡ä»¶å‘é€å™¨ - ä¿®å¤ç‰ˆ</title>
    <script src="js/pako.min.js"></script>
    <script src="js/qrcode.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            max-width: 1000px; 
            margin: 20px auto; 
            padding: 20px;
            background: #f5f7fa;
            color: #333;
        }
        .container { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            padding: 30px; 
        }
        h1 { 
            color: #2c3e50; 
            margin-bottom: 10px; 
            border-bottom: 3px solid #3498db; 
            padding-bottom: 10px;
        }
        .subtitle { 
            color: #7f8c8d; 
            margin-bottom: 30px; 
            font-size: 16px;
        }
        .file-section { 
            margin-bottom: 30px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 8px;
        }
        #fileInput { 
            display: block; 
            width: 100%; 
            padding: 12px; 
            margin: 15px 0; 
            border: 2px dashed #3498db; 
            border-radius: 8px; 
            cursor: pointer;
            background: #e8f4fc;
        }
        .file-info { 
            margin-top: 15px; 
            padding: 12px; 
            background: #e8f4fc; 
            border-left: 4px solid #3498db; 
            border-radius: 4px;
        }
        .chunk-size-section, .qr-size-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
        }
        .slider-value {
            min-width: 80px;
            font-weight: bold;
            color: #3498db;
            font-size: 18px;
            text-align: center;
            padding: 5px 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #3498db;
        }
        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2980b9;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }
        .size-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            color: #7f8c8d;
            font-size: 14px;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            color: #856404;
            font-size: 14px;
        }
        .control-section { 
            margin: 25px 0; 
            text-align: center; 
        }
        button { 
            padding: 14px 36px; 
            margin: 0 10px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #startBtn { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        #startBtn:hover { 
            background: linear-gradient(135deg, #2980b9, #1c5d87); 
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
        }
        #startBtn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        #resetBtn { 
            background: #e0e0e0; 
            color: #555; 
        }
        #resetBtn:hover { 
            background: #d0d0d0; 
        }
        .qrcode-section { 
            margin-top: 30px; 
            text-align: center; 
        }
        #qrcodeContainer { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 20px; 
            margin: 25px 0; 
            min-height: 400px;
            align-items: flex-start;
        }
        .qrcode-item { 
            padding: 15px; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 3px 12px rgba(0,0,0,0.1); 
            text-align: center;
            transition: transform 0.3s ease;
        }
        .qrcode-item:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .qrcode-item img { 
            display: block; 
            margin: 0 auto 10px; 
        }
        .progress-info { 
            margin: 20px 0; 
            font-size: 18px; 
            color: #2c3e50; 
            font-weight: 600;
        }
        .current-qr { 
            background: #e8f7f0 !important; 
            border: 2px solid #2ecc71 !important; 
        }
        .file-name-qr {
            background: #fff3e0 !important;
            border: 2px solid #ff9800 !important;
        }
        .status { 
            padding: 12px 20px; 
            border-radius: 8px; 
            margin: 20px 0; 
            font-weight: 500;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .status.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .status.info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .footer { 
            margin-top: 30px; 
            text-align: center; 
            color: #7f8c8d; 
            font-size: 14px; 
            border-top: 1px solid #eee; 
            padding-top: 20px;
        }
        .fingerprint-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: #e8f4fc;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        .debug-info {
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 3px solid #6c757d;
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            #qrcodeContainer { gap: 15px; }
            button { 
                padding: 12px 24px; 
                margin: 5px; 
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¤ ç¦»çº¿æ–‡ä»¶äºŒç»´ç å‘é€å™¨ - ä¿®å¤ç‰ˆ</h1>
        <p class="subtitle">é€‰æ‹©æ–‡ä»¶åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å‹ç¼©ã€åˆ†ç‰‡å¹¶ç”ŸæˆäºŒç»´ç åºåˆ—ã€‚<strong style="color:#e74c3c;">æ–‡ä»¶ååœ¨æœ€åä¸€ä¸ªäºŒç»´ç ä¸­</strong>ã€‚</p>
        
        <div class="file-section">
            <h3>1. é€‰æ‹©è¦å‘é€çš„æ–‡ä»¶</h3>
            <input type="file" id="fileInput">
            <div id="fileInfo" class="file-info" style="display:none;">
                <strong>å·²é€‰æ‹©æ–‡ä»¶:</strong> <span id="fileName"></span><br>
                <strong>æ–‡ä»¶å¤§å°:</strong> <span id="fileSize"></span><br>
                <strong>æ–‡ä»¶ç±»å‹:</strong> <span id="fileType"></span><br>
                <div id="fingerprintInfo" class="fingerprint-info" style="display:none;">
                    <strong>æ–‡ä»¶æŒ‡çº¹:</strong> <span id="fileFingerprint"></span>
                </div>
            </div>
        </div>
        
        <div class="chunk-size-section">
            <h3>2. è®¾ç½®åˆ†ç‰‡å¤§å°</h3>
            <p style="color: #666; margin-bottom: 10px;"><strong>âš ï¸ é‡è¦ï¼šå»ºè®®ä½¿ç”¨600å­—èŠ‚ä»¥ä¸‹çš„åˆ†ç‰‡å¤§å°ä»¥ç¡®ä¿ç¨³å®šæ€§</strong></p>
            
            <div class="slider-container">
                <span style="font-weight: 600;">åˆ†ç‰‡å¤§å°:</span>
                <input type="range" id="chunkSizeSlider" min="500" max="2000" value="900" step="50">
                <div id="chunkSizeValue" class="slider-value">900 å­—èŠ‚</div>
            </div>
            
            <div class="size-info">
                <span>å°åˆ†ç‰‡ (500B)</span>
                <span>æ¨è (900B)</span>
                <span>å¤§åˆ†ç‰‡ (2000B)</span>
            </div>
            
            <div class="warning-box">
                âš ï¸ å®‰å…¨é™åˆ¶ï¼šæ¯ä¸ªåˆ†ç‰‡çš„JSONæ•°æ®å¿…é¡»å°äº1800å­—ç¬¦ã€‚è¶…è¿‡æ­¤é™åˆ¶ä¼šå¯¼è‡´äºŒç»´ç ç”Ÿæˆå¤±è´¥ã€‚
            </div>
            
            <div id="estimatedInfo" style="margin-top: 15px; color: #3498db; font-weight: 500;">
                é¢„ä¼°äºŒç»´ç æ•°é‡: <span id="estimatedChunks">--</span> ä¸ª (æ•°æ®äºŒç»´ç +1ä¸ªæ–‡ä»¶åäºŒç»´ç )
            </div>
        </div>
        
        <div class="qr-size-section">
            <h3>3. è®¾ç½®äºŒç»´ç å°ºå¯¸</h3>
            <p style="color: #666; margin-bottom: 10px;">è°ƒæ•´æ˜¾ç¤ºå°ºå¯¸ï¼ˆ200-800åƒç´ ï¼‰ã€‚æ³¨æ„ï¼šè°ƒæ•´å°ºå¯¸ä¸ä¼šé‡æ–°ç”ŸæˆäºŒç»´ç ï¼Œä»…æ”¹å˜æ˜¾ç¤ºå¤§å°ã€‚</p>
            
            <div class="slider-container">
                <span style="font-weight: 600;">æ˜¾ç¤ºå°ºå¯¸:</span>
                <input type="range" id="qrSizeSlider" min="200" max="800" value="500" step="50">
                <div id="qrSizeValue" class="slider-value">500 åƒç´ </div>
            </div>
            
            <div class="size-info">
                <span>å°å°ºå¯¸ (200px)</span>
                <span>å¤§å°ºå¯¸ (800px)</span>
            </div>
        </div>
        
        <div class="control-section">
            <h3>4. ç”ŸæˆäºŒç»´ç </h3>
            <button id="startBtn">ğŸš€ å¼€å§‹ç”ŸæˆäºŒç»´ç åºåˆ—</button>
            <button id="resetBtn">ğŸ”„ é‡ç½®</button>
        </div>
        
        <div id="status" class="status info">è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶</div>
        
        <div class="qrcode-section">
            <h3>5. æ‰«æäºŒç»´ç  (æŒ‰é¡ºåº)</h3>
            <div class="progress-info" id="progressInfo"></div>
            <div id="qrcodeContainer">
                <p style="color: #7f8c8d; padding: 50px 0;">äºŒç»´ç å°†åœ¨æ­¤å¤„æ˜¾ç¤º...</p>
            </div>
        </div>
        
        <div class="footer">
            <p>ğŸ’¡ æç¤º: ç¡®ä¿ç”µè„‘å±å¹•äº®åº¦è¶³å¤Ÿï¼Œæ‰‹æœºæ‘„åƒå¤´å¯¹ç„¦æ¸…æ™°ã€‚æŒ‰é¡ºåºæ‰«ææ‰€æœ‰äºŒç»´ç ã€‚</p>
            <p><strong style="color:#e74c3c;">æ–°æ–¹æ¡ˆï¼šæ–‡ä»¶ååœ¨æœ€åä¸€ä¸ªå•ç‹¬çš„äºŒç»´ç ä¸­ï¼Œé¿å…ä¸­æ–‡æ–‡ä»¶åå¯¼è‡´çš„äºŒç»´ç å®¹é‡é—®é¢˜</strong></p>
        </div>
    </div>

    <script>
        // ==================== é…ç½®å’Œå¸¸é‡ ====================
        const CONFIG = {
            CHUNK_SIZE: 900,
            QR_DISPLAY_SIZE: 500,
            QR_GENERATE_SIZE: 500,
            MAX_JSON_SIZE: 1800,
            QR_MAX_CAPACITY: 2953,
            PACKET_TYPES: {
                DATA: 'data',
                FILENAME: 'fn'
            }
        };

        // ==================== çŠ¶æ€å˜é‡ ====================
        let file = null;
        let chunks = [];
        let currentChunkIndex = 0;
        let fileFingerprint = '';
        let originalFileName = '';
        let originalFileSize = 0;
        let qrCodeDataUrls = [];
        let fileNameQrCode = null;

        // ==================== å·¥å…·å‡½æ•° ====================
        
        /**
         * ç”Ÿæˆ5å­—ç¬¦æ–‡ä»¶æŒ‡çº¹
         */
        function generateShortFileId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 46656);
            const combined = (timestamp % 60466176) * 1000 + random;
            return combined.toString(36).padStart(5, '0').slice(-5);
        }

        /**
         * è®¡ç®—CRC32æ ¡éªŒç ï¼ˆä½¿ç”¨pakoåº“ï¼Œä¸æ¥æ”¶ç«¯ä¸€è‡´ï¼‰
         */
        function calculateCRC32(data) {
            // ä½¿ç”¨pakoçš„crc32å‡½æ•°ç¡®ä¿ä¸€è‡´æ€§
            if (typeof pako !== 'undefined' && pako.crc32) {
                return pako.crc32(data).toString(36).padStart(5, '0').slice(-5);
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šç¡®ä¿ä¸æ¥æ”¶ç«¯ä¸€è‡´çš„å®ç°
            return calculateCRC32Fallback(data);
        }

        /**
         * CRC32å¤‡ç”¨å®ç°ï¼ˆç¡®ä¿ä¸æ¥æ”¶ç«¯ä¸€è‡´ï¼‰
         */
        function calculateCRC32Fallback(data) {
            const table = new Uint32Array(256);
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) {
                    c = (c & 1) ? 0xEDB88320 ^ (c >>> 1) : c >>> 1;
                }
                table[i] = c;
            }
            
            let crc = 0xFFFFFFFF;
            const len = data.length;
            
            for (let i = 0; i < len; i++) {
                crc = (crc >>> 8) ^ table[(crc ^ data.charCodeAt(i)) & 0xFF];
            }
            crc = (crc ^ 0xFFFFFFFF) >>> 0;
            return crc.toString(36).padStart(5, '0').slice(-5);
        }

        /**
         * æ­£ç¡®ç¼–ç æ–‡ä»¶åä¸ºBase64
         */
        function encodeFileName(filename) {
            try {
                // ä½¿ç”¨TextEncoderå¤„ç†UTF-8
                const encoder = new TextEncoder();
                const encoded = encoder.encode(filename);
                return btoa(String.fromCharCode(...encoded));
            } catch (e) {
                console.error('æ–‡ä»¶åç¼–ç å¤±è´¥:', e);
                // å›é€€æ–¹æ¡ˆ
                return btoa(unescape(encodeURIComponent(filename)));
            }
        }

        /**
         * Uint8Arrayè½¬Base64ï¼ˆç»Ÿä¸€ä½¿ç”¨ï¼‰
         */
        function uint8ArrayToBase64(uint8Array) {
            const base64Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
            let result = '';
            const len = uint8Array.length;
            
            for (let i = 0; i < len; i += 3) {
                const byte1 = uint8Array[i];
                const byte2 = i + 1 < len ? uint8Array[i + 1] : 0;
                const byte3 = i + 2 < len ? uint8Array[i + 2] : 0;
                
                const triplet = (byte1 << 16) | (byte2 << 8) | byte3;
                
                result += base64Chars.charAt((triplet >> 18) & 63);
                result += base64Chars.charAt((triplet >> 12) & 63);
                result += (i + 1 < len) ? base64Chars.charAt((triplet >> 6) & 63) : '=';
                result += (i + 2 < len) ? base64Chars.charAt(triplet & 63) : '=';
            }
            
            return result;
        }

        /**
         * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
         */
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        /**
         * è¯»å–æ–‡ä»¶ä¸ºArrayBuffer
         */
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
         */
        function showError(message, error = null) {
            status.textContent = `âŒ ${message}`;
            status.className = 'status error';
            
            if (error) {
                console.error(message, error);
            }
        }

        /**
         * æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
         */
        function showSuccess(message) {
            status.textContent = `âœ… ${message}`;
            status.className = 'status success';
        }

        /**
         * æ˜¾ç¤ºä¿¡æ¯
         */
        function showInfo(message) {
            status.textContent = `â„¹ï¸ ${message}`;
            status.className = 'status info';
        }

        // ==================== DOMå…ƒç´ ç¼“å­˜ ====================
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileType = document.getElementById('fileType');
        const fingerprintInfo = document.getElementById('fingerprintInfo');
        const fileFingerprintSpan = document.getElementById('fileFingerprint');
        const chunkSizeSlider = document.getElementById('chunkSizeSlider');
        const chunkSizeValue = document.getElementById('chunkSizeValue');
        const estimatedChunks = document.getElementById('estimatedChunks');
        const qrSizeSlider = document.getElementById('qrSizeSlider');
        const qrSizeValue = document.getElementById('qrSizeValue');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const qrcodeContainer = document.getElementById('qrcodeContainer');
        const progressInfo = document.getElementById('progressInfo');
        const status = document.getElementById('status');

        // ==================== äº‹ä»¶å¤„ç† ====================
        
        // åˆå§‹åŒ–æ»‘å—æ˜¾ç¤º
        chunkSizeValue.textContent = CONFIG.CHUNK_SIZE + ' å­—èŠ‚';
        qrSizeValue.textContent = CONFIG.QR_DISPLAY_SIZE + ' åƒç´ ';

        // æ»‘å—äº‹ä»¶å¤„ç†
        chunkSizeSlider.addEventListener('input', function() {
            CONFIG.CHUNK_SIZE = parseInt(this.value);
            chunkSizeValue.textContent = CONFIG.CHUNK_SIZE + ' å­—èŠ‚';
            if (file) updateChunkEstimation();
        });

        // äºŒç»´ç å°ºå¯¸æ»‘å—
        qrSizeSlider.addEventListener('input', function() {
            CONFIG.QR_DISPLAY_SIZE = parseInt(this.value);
            qrSizeValue.textContent = CONFIG.QR_DISPLAY_SIZE + ' åƒç´ ';
            
            const qrImages = document.querySelectorAll('.qrcode-item img');
            qrImages.forEach(img => {
                img.style.width = CONFIG.QR_DISPLAY_SIZE + 'px';
                img.style.height = CONFIG.QR_DISPLAY_SIZE + 'px';
            });
            
            const qrItems = document.querySelectorAll('.qrcode-item');
            qrItems.forEach(item => {
                item.style.maxWidth = (CONFIG.QR_DISPLAY_SIZE + 40) + 'px';
            });
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', function(e) {
            file = e.target.files[0];
            if (file) {
                originalFileName = file.name;
                originalFileSize = file.size;
                fileName.textContent = originalFileName;
                fileSize.textContent = formatFileSize(originalFileSize);
                fileType.textContent = file.type || 'æœªçŸ¥ç±»å‹';
                
                fileFingerprint = generateShortFileId();
                fileFingerprintSpan.textContent = fileFingerprint;
                fingerprintInfo.style.display = 'block';
                fileInfo.style.display = 'block';
                
                updateChunkEstimation();
                
                showSuccess(`å·²é€‰æ‹©æ–‡ä»¶: ${file.name} (${formatFileSize(file.size)})`);
                
                console.log('æ–‡ä»¶å·²é€‰æ‹©:', file.name, 'å¤§å°:', file.size, 'æŒ‡çº¹:', fileFingerprint);
            } else {
                fileInfo.style.display = 'none';
                showInfo('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
            }
        });

        // æ›´æ–°äºŒç»´ç æ•°é‡é¢„ä¼°
        function updateChunkEstimation() {
            if (!file) return;
            const estimatedCompressedSize = file.size * 0.5;
            const estimated = Math.ceil(estimatedCompressedSize / CONFIG.CHUNK_SIZE);
            estimatedChunks.textContent = estimated + ' + 1';
            
            if (estimated > 50) {
                showInfo(`æ–‡ä»¶è¾ƒå¤§ï¼Œé¢„è®¡ç”Ÿæˆ ${estimated} ä¸ªæ•°æ®äºŒç»´ç  + 1ä¸ªæ–‡ä»¶åäºŒç»´ç ã€‚å»ºè®®å‡å°åˆ†ç‰‡å¤§å°ä»¥æé«˜æ‰«ææˆåŠŸç‡ã€‚`);
            }
        }

        // å¼€å§‹å¤„ç†æ–‡ä»¶
        startBtn.addEventListener('click', async function() {
            console.log('å¼€å§‹å¤„ç†æ–‡ä»¶æŒ‰é’®è¢«ç‚¹å‡»');
            
            if (!file) {
                showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥å¿…è¦ä¾èµ–
            if (typeof QRCode === 'undefined') {
                showError('QRCodeåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥js/qrcode.min.jsæ–‡ä»¶');
                return;
            }
            
            if (typeof pako === 'undefined') {
                showError('å‹ç¼©åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥js/pako.min.jsæ–‡ä»¶');
                return;
            }
            
            try {
                startBtn.disabled = true;
                startBtn.textContent = 'å¤„ç†ä¸­...';
                showInfo('æ­£åœ¨è¯»å–å¹¶å‹ç¼©æ–‡ä»¶...');
                
                console.log('=== å¼€å§‹å¤„ç†æ–‡ä»¶ ===');
                console.log(`æ–‡ä»¶å: ${originalFileName}`);
                console.log(`æ–‡ä»¶å¤§å°: ${originalFileSize} å­—èŠ‚`);
                console.log(`åˆ†ç‰‡å¤§å°: ${CONFIG.CHUNK_SIZE} å­—èŠ‚`);
                console.log(`æ–‡ä»¶æŒ‡çº¹: ${fileFingerprint}`);
                
                // 1. è¯»å–æ–‡ä»¶
                const fileBuffer = await readFileAsArrayBuffer(file);
                
                // 2. ä½¿ç”¨zlibå‹ç¼©
                console.log('æ­£åœ¨å‹ç¼©æ–‡ä»¶...');
                const compressed = pako.deflate(new Uint8Array(fileBuffer));
                console.log(`å‹ç¼©å‰: ${fileBuffer.byteLength} bytes, å‹ç¼©å: ${compressed.length} bytes`);
                
                // 3. åˆ†ç‰‡å¤„ç†
                await processFileChunks(compressed);
                
            } catch (error) {
                console.error('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
                showError(`å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`, error);
                startBtn.disabled = false;
                startBtn.textContent = 'ğŸš€ å¼€å§‹ç”ŸæˆäºŒç»´ç åºåˆ—';
            }
        });

        /**
         * å¤„ç†æ–‡ä»¶åˆ†ç‰‡
         */
        async function processFileChunks(compressed) {
            chunks = [];
            qrCodeDataUrls = [];
            fileNameQrCode = null;
            
            console.log('å‹ç¼©æ•°æ®éªŒè¯:');
            console.log('- åŸå§‹æ–‡ä»¶å¤§å°:', file.size, 'å­—èŠ‚');
            console.log('- å‹ç¼©åå¤§å°:', compressed.length, 'å­—èŠ‚');
            console.log('- å‹ç¼©ç‡:', ((compressed.length / file.size) * 100).toFixed(1) + '%');

            const totalChunks = Math.ceil(compressed.length / CONFIG.CHUNK_SIZE);
            console.log(`åˆ†ç‰‡è®¾ç½®: ${compressed.length} å­—èŠ‚ / ${CONFIG.CHUNK_SIZE} å­—èŠ‚ = ${totalChunks} ä¸ªåˆ†ç‰‡`);

            if (totalChunks <= 0) {
                throw new Error('åˆ†ç‰‡è®¡ç®—é”™è¯¯ï¼šæ€»åˆ†ç‰‡æ•°ä¸º0');
            }

            showInfo(`æ­£åœ¨åˆ†ç‰‡... (å…± ${totalChunks} ä¸ªæ•°æ®åˆ†ç‰‡)`);

            // å°†å‹ç¼©æ•°æ®è½¬æ¢ä¸ºUint8Array
            const compressedArray = new Uint8Array(compressed);
            
            for (let i = 0; i < totalChunks; i++) {
                const start = i * CONFIG.CHUNK_SIZE;
                const end = Math.min(start + CONFIG.CHUNK_SIZE, compressed.length);
                
                const chunkData = compressedArray.slice(start, end);
                console.log(`åˆ†ç‰‡ ${i}: ä½ç½® ${start}-${end}, å¤§å° ${chunkData.length} å­—èŠ‚`);
                
                // è½¬æ¢ä¸ºBase64
                const base64Data = uint8ArrayToBase64(chunkData);
                console.log(`Base64å¤§å°: ${base64Data.length} å­—ç¬¦`);
                
                // è®¡ç®—CRC32æ ¡éªŒï¼ˆä½¿ç”¨pakoåº“ç¡®ä¿ä¸€è‡´æ€§ï¼‰
                const crc32Hash = calculateCRC32(base64Data);
                
                // åˆ›å»ºåˆ†ç‰‡å¯¹è±¡
                const chunkObj = {
                    i: i,                    // åˆ†ç‰‡ç´¢å¼•
                    t: totalChunks,          // æ€»åˆ†ç‰‡æ•°
                    h: crc32Hash,            // CRC32æ ¡éªŒç 
                    f: fileFingerprint,      // æ–‡ä»¶æŒ‡çº¹
                    d: base64Data            // æ•°æ®
                };
                
                // æ£€æŸ¥JSONå¤§å°
                const jsonStr = JSON.stringify(chunkObj);
                const jsonSize = jsonStr.length;
                console.log(`åˆ†ç‰‡ ${i} JSONå¤§å°: ${jsonSize} å­—ç¬¦`);
                
                // äºŒç»´ç å®¹é‡é™åˆ¶æ£€æŸ¥
                if (jsonSize > CONFIG.QR_MAX_CAPACITY) {
                    console.error(`âŒ JSONè¿‡å¤§: ${jsonSize} > ${CONFIG.QR_MAX_CAPACITY}`);
                    
                    const excessRatio = jsonSize / CONFIG.QR_MAX_CAPACITY;
                    const newChunkSize = Math.floor(CONFIG.CHUNK_SIZE / excessRatio * 0.8);
                    
                    showError(`åˆ†ç‰‡ ${i+1} æ•°æ®è¿‡å¤§ (${jsonSize} å­—ç¬¦)ã€‚è¯·å°†åˆ†ç‰‡å¤§å°å‡å°åˆ° ${Math.max(200, newChunkSize)} å­—èŠ‚ä»¥ä¸‹ã€‚`);
                    
                    chunkSizeSlider.value = Math.max(200, newChunkSize);
                    chunkSizeValue.textContent = Math.max(200, newChunkSize) + ' å­—èŠ‚';
                    CONFIG.CHUNK_SIZE = Math.max(200, newChunkSize);
                    
                    startBtn.disabled = false;
                    startBtn.textContent = 'ğŸš€ é‡æ–°ç”ŸæˆäºŒç»´ç ';
                    return;
                }
                
                chunks.push(chunkObj);
                
                // æ˜¾ç¤ºè¿›åº¦
                if (i % Math.max(1, Math.floor(totalChunks / 10)) === 0) {
                    showInfo(`åˆ†ç‰‡è¿›åº¦: ${i+1}/${totalChunks}`);
                }
            }
            
            console.log(`âœ… æ•°æ®åˆ†ç‰‡å®Œæˆï¼Œå…± ${totalChunks} ä¸ªåˆ†ç‰‡`);
            
            // 4. åˆ›å»ºæ–‡ä»¶åäºŒç»´ç 
            console.log('åˆ›å»ºæ–‡ä»¶åäºŒç»´ç ...');
            createFileNameQrCode(totalChunks);
            
            console.log('=== å¼€å§‹ç”ŸæˆäºŒç»´ç  ===');
            showSuccess(`æ–‡ä»¶å¤„ç†å®Œæˆ! å…± ${totalChunks} ä¸ªæ•°æ®åˆ†ç‰‡ + 1ä¸ªæ–‡ä»¶ååˆ†ç‰‡ï¼Œå‡†å¤‡ç”ŸæˆäºŒç»´ç ...`);
            
            // 5. ç”Ÿæˆæ‰€æœ‰äºŒç»´ç 
            await generateQRCodeSequence();
        }

        /**
         * åˆ›å»ºæ–‡ä»¶åäºŒç»´ç æ•°æ®
         */
        function createFileNameQrCode(totalChunks) {
            // æ­£ç¡®ç¼–ç æ–‡ä»¶å
            const encodedFileName = encodeFileName(originalFileName);
            const fileNameData = {
                t: CONFIG.PACKET_TYPES.FILENAME,
                f: fileFingerprint,
                n: encodedFileName,
                s: originalFileSize,
                ts: Date.now(),
                tc: totalChunks
            };
            
            // è®¡ç®—CRC32æ ¡éªŒï¼ˆä¸æ•°æ®åˆ†ç‰‡ä½¿ç”¨ç›¸åŒç®—æ³•ï¼‰
            const crcData = {
                t: fileNameData.t,
                f: fileNameData.f,
                n: fileNameData.n,
                s: fileNameData.s,
                ts: fileNameData.ts,
                tc: fileNameData.tc
            };
            const crc32Hash = calculateCRC32(JSON.stringify(crcData));
            fileNameData.h = crc32Hash;
            
            console.log(`æ–‡ä»¶åæ•°æ®JSONé•¿åº¦: ${JSON.stringify(fileNameData).length} å­—ç¬¦`);
            console.log(`åŸå§‹æ–‡ä»¶å: ${originalFileName}`);
            console.log(`ç¼–ç åæ–‡ä»¶å: ${encodedFileName}`);
            console.log(`CRC32æ ¡éªŒ: ${crc32Hash}`);
            
            fileNameQrCode = fileNameData;
        }

        /**
         * ç”ŸæˆäºŒç»´ç åºåˆ—
         */
        async function generateQRCodeSequence() {
            qrcodeContainer.innerHTML = '';
            currentChunkIndex = 0;
            
            if (chunks.length === 0 && !fileNameQrCode) {
                showError('æ²¡æœ‰å¯åˆ†ç‰‡çš„æ•°æ®');
                return;
            }
            
            const totalQRCodes = chunks.length + 1;
            showInfo(`æ­£åœ¨ç”Ÿæˆ ${totalQRCodes} ä¸ªäºŒç»´ç ... (è¯·ç¨å€™)`);
            
            qrCodeDataUrls = [];
            
            // ç”Ÿæˆæ•°æ®äºŒç»´ç 
            for (let index = 0; index < chunks.length; index++) {
                await generateQRCodeForChunk(index, chunks[index], CONFIG.PACKET_TYPES.DATA, totalQRCodes);
            }
            
            // ç”Ÿæˆæ–‡ä»¶åäºŒç»´ç ï¼ˆæœ€åä¸€ä¸ªï¼‰
            if (fileNameQrCode) {
                await generateQRCodeForChunk(chunks.length, fileNameQrCode, CONFIG.PACKET_TYPES.FILENAME, totalQRCodes);
            }
            
            updateProgress();
            
            showSuccess(`äºŒç»´ç ç”Ÿæˆå®Œæˆ! å…± ${totalQRCodes} ä¸ªäºŒç»´ç ï¼Œè¯·æŒ‰é¡ºåºæ‰«æ`);
            startBtn.disabled = false;
            startBtn.textContent = 'ğŸš€ å¼€å§‹ç”ŸæˆäºŒç»´ç åºåˆ—';
            
            console.log('=== äºŒç»´ç ç”Ÿæˆå®Œæˆ ===');
            console.log(`å…±ç”Ÿæˆ ${totalQRCodes} ä¸ªäºŒç»´ç `);
            console.log(`æ–‡ä»¶æŒ‡çº¹: ${fileFingerprint}`);
            console.log(`åŸå§‹æ–‡ä»¶å: ${originalFileName}`);
        }

        /**
         * ä¸ºåˆ†ç‰‡ç”ŸæˆäºŒç»´ç 
         */
        async function generateQRCodeForChunk(index, chunk, type, total) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    try {
                        const jsonStr = JSON.stringify(chunk);
                        console.log(`ç”ŸæˆäºŒç»´ç  ${index+1}/${total} (${type}): ${jsonStr.length} å­—ç¬¦`);
                        
                        // åˆ›å»ºåˆ†ç‰‡å®¹å™¨
                        const chunkDiv = document.createElement('div');
                        chunkDiv.className = 'qrcode-item';
                        chunkDiv.id = `chunk-${index}`;
                        chunkDiv.style.maxWidth = `${CONFIG.QR_DISPLAY_SIZE + 40}px`;
                        
                        if (type === CONFIG.PACKET_TYPES.FILENAME) {
                            chunkDiv.classList.add('file-name-qr');
                        }
                        
                        // åˆ›å»ºå ä½ç¬¦
                        const placeholder = document.createElement('div');
                        placeholder.style.cssText = `
                            width: ${CONFIG.QR_DISPLAY_SIZE}px;
                            height: ${CONFIG.QR_DISPLAY_SIZE}px;
                            background: #f0f0f0;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #666;
                            font-size: 14px;
                            margin: 0 auto 10px;
                            border-radius: 5px;
                        `;
                        
                        let placeholderText = `ç”Ÿæˆä¸­ ${index+1}/${total}<br>`;
                        if (type === CONFIG.PACKET_TYPES.FILENAME) {
                            placeholderText += 'æ–‡ä»¶å';
                        } else {
                            placeholderText += 'æ•°æ®';
                        }
                        placeholder.innerHTML = placeholderText;
                        chunkDiv.appendChild(placeholder);
                        
                        // åˆ†ç‰‡ä¿¡æ¯
                        const infoDiv = document.createElement('div');
                        let infoHTML = '';
                        
                        if (type === CONFIG.PACKET_TYPES.DATA) {
                            infoHTML = `
                                <strong>æ•°æ®åˆ†ç‰‡ ${chunk.i + 1}/${chunk.t}</strong><br>
                                <small>æŒ‡çº¹: ${chunk.f}</small><br>
                                <small>æ ¡éªŒ: ${chunk.h}</small><br>
                                <small>${jsonStr.length} å­—èŠ‚</small>
                            `;
                        } else {
                            // æ–‡ä»¶åäºŒç»´ç 
                            const encodedName = chunk.n || '';
                            const displayName = encodedName.length > 30 ? 
                                encodedName.substring(0, 30) + '...' : 
                                encodedName;
                            infoHTML = `
                                <strong style="color:#ff9800;">ğŸ“„ æ–‡ä»¶ååˆ†ç‰‡</strong><br>
                                <small>æŒ‡çº¹: ${chunk.f}</small><br>
                                <small>ç¼–ç å: ${displayName}</small><br>
                                <small>å¤§å°: ${formatFileSize(chunk.s)}</small><br>
                                <small>${jsonStr.length} å­—èŠ‚</small>
                            `;
                        }
                        
                        infoDiv.innerHTML = infoHTML;
                        chunkDiv.appendChild(infoDiv);
                        
                        // æ·»åŠ åˆ°å®¹å™¨
                        qrcodeContainer.appendChild(chunkDiv);
                        
                        // ç”ŸæˆäºŒç»´ç å›¾ç‰‡
                        generateQRCodeImage(chunkDiv, placeholder, index, chunk, type);
                        
                        resolve();
                    } catch (error) {
                        console.error(`ç”ŸæˆäºŒç»´ç  ${index+1} æ—¶å‡ºé”™:`, error);
                        resolve();
                    }
                }, index * 50);
            });
        }

        /**
         * ç”ŸæˆäºŒç»´ç å›¾ç‰‡
         */
        function generateQRCodeImage(container, placeholder, index, chunk, type) {
            try {
                const jsonStr = JSON.stringify(chunk);
                
                // æ£€æŸ¥QRCodeåº“æ˜¯å¦å¯ç”¨
                if (typeof QRCode === 'undefined') {
                    throw new Error('QRCodeåº“æœªåŠ è½½');
                }
                
                // åˆ›å»ºä¸´æ—¶éšè—çš„divç”¨äºç”ŸæˆäºŒç»´ç 
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                // ç”ŸæˆäºŒç»´ç 
                new QRCode(tempDiv, {
                    text: jsonStr,
                    width: CONFIG.QR_GENERATE_SIZE,
                    height: CONFIG.QR_GENERATE_SIZE,
                    colorDark: type === CONFIG.PACKET_TYPES.FILENAME ? '#ff9800' : '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.L
                });
                
                // å»¶è¿Ÿç¡®ä¿äºŒç»´ç æ¸²æŸ“å®Œæˆ
                setTimeout(() => {
                    const canvas = tempDiv.querySelector('canvas');
                    if (canvas) {
                        try {
                            // è½¬æ¢ä¸ºæ•°æ®URL
                            const dataUrl = canvas.toDataURL('image/png');
                            qrCodeDataUrls[index] = dataUrl;
                            
                            // æ›¿æ¢å ä½ç¬¦ä¸ºäºŒç»´ç å›¾ç‰‡
                            const img = document.createElement('img');
                            img.src = dataUrl;
                            img.style.width = CONFIG.QR_DISPLAY_SIZE + 'px';
                            img.style.height = CONFIG.QR_DISPLAY_SIZE + 'px';
                            img.style.margin = '0 auto 10px';
                            img.style.display = 'block';
                            img.alt = `äºŒç»´ç  ${index + 1}`;
                            
                            container.replaceChild(img, placeholder);
                            
                            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                            const debugDiv = document.createElement('div');
                            debugDiv.className = 'debug-info';
                            let debugText = `ç±»å‹:${type} é•¿åº¦:${jsonStr.length}B`;
                            if (type === CONFIG.PACKET_TYPES.FILENAME) {
                                debugText += ` æ–‡ä»¶:${chunk.n ? chunk.n.length : 0}å­—ç¬¦`;
                            } else {
                                debugText += ` æ•°æ®:${chunk.d ? chunk.d.length : 0}B`;
                            }
                            debugDiv.innerHTML = debugText;
                            container.appendChild(debugDiv);
                            
                            console.log(`âœ… äºŒç»´ç  ${index+1} ç”ŸæˆæˆåŠŸ (${type})`);
                            
                        } catch (imgError) {
                            console.error(`âŒ å›¾ç‰‡è½¬æ¢å¤±è´¥ ${index+1}:`, imgError);
                            placeholder.innerHTML = `âŒ ç”Ÿæˆå¤±è´¥<br><small>${imgError.message}</small>`;
                            placeholder.style.background = '#f8d7da';
                            placeholder.style.color = '#721c24';
                        }
                    } else {
                        console.error(`âŒ Canvasæœªæ‰¾åˆ° ${index+1}`);
                        placeholder.innerHTML = 'âŒ Canvasç”Ÿæˆå¤±è´¥';
                        placeholder.style.background = '#f8d7da';
                        placeholder.style.color = '#721c24';
                    }
                    
                    // æ¸…ç†ä¸´æ—¶å…ƒç´ 
                    document.body.removeChild(tempDiv);
                }, 10);
                
            } catch (qrError) {
                console.error(`âŒ ç”ŸæˆäºŒç»´ç  ${index+1} æ—¶å‡ºé”™:`, qrError);
                placeholder.innerHTML = `âŒ ç”Ÿæˆé”™è¯¯<br><small>${qrError.message}</small>`;
                placeholder.style.background = '#f8d7da';
                placeholder.style.color = '#721c24';
            }
        }

        /**
         * æ›´æ–°æ‰«æè¿›åº¦æ˜¾ç¤º
         */
        function updateProgress() {
            const totalQRCodes = chunks.length + (fileNameQrCode ? 1 : 0);
            progressInfo.innerHTML = `ğŸ“Š æ€»å…±: <span style="color:#3498db">${totalQRCodes}</span> ä¸ªäºŒç»´ç  (${chunks.length}ä¸ªæ•°æ® + 1ä¸ªæ–‡ä»¶å)`;
            
            document.querySelectorAll('.qrcode-item').forEach((item, index) => {
                if (index === currentChunkIndex) {
                    item.classList.add('current-qr');
                } else {
                    item.classList.remove('current-qr');
                }
            });
        }

        // é‡ç½®
        resetBtn.addEventListener('click', function() {
            fileInput.value = '';
            file = null;
            fileFingerprint = '';
            originalFileName = '';
            originalFileSize = 0;
            chunks = [];
            qrCodeDataUrls = [];
            fileNameQrCode = null;
            currentChunkIndex = 0;
            fileInfo.style.display = 'none';
            fingerprintInfo.style.display = 'none';
            qrcodeContainer.innerHTML = '<p style="color: #7f8c8d; padding: 50px 0;">äºŒç»´ç å°†åœ¨æ­¤å¤„æ˜¾ç¤º...</p>';
            progressInfo.innerHTML = '';
            showInfo('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
            startBtn.disabled = false;
            startBtn.textContent = 'ğŸš€ å¼€å§‹ç”ŸæˆäºŒç»´ç åºåˆ—';
            chunkSizeSlider.value = 900;
            chunkSizeValue.textContent = '900 å­—èŠ‚';
            CONFIG.CHUNK_SIZE = 900;
            qrSizeSlider.value = 500;
            qrSizeValue.textContent = '500 åƒç´ ';
            CONFIG.QR_DISPLAY_SIZE = 500;
            estimatedChunks.textContent = '--';
        });

        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼ŒäºŒç»´ç æ–‡ä»¶å‘é€å™¨å·²åˆå§‹åŒ–');
            
            // æ£€æŸ¥å¿…è¦ä¾èµ–
            if (typeof QRCode === 'undefined') {
                showError('QRCodeåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥js/qrcode.min.jsæ–‡ä»¶');
            }
            
            if (typeof pako === 'undefined') {
                showError('å‹ç¼©åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥js/pako.min.jsæ–‡ä»¶');
            }
            
            if (!window.File || !window.FileReader) {
                showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶æ“ä½œåŠŸèƒ½');
            }
            
            showInfo('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
        });
    </script>
</body>
</html>