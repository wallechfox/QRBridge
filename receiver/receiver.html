<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç æ–‡ä»¶æ¥æ”¶å™¨ - V1.0</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuemu+e6v+aWh+S7tuaOpeaUtOWZqCIsCiAgInNob3J0X25hbWUiOiAiUVLmjqXmlLblmaoiLAogICJkZXNjcmlwdGlvbiI6ICLpgJrov4fkuoznu7TnoIHluo/liJfnsbvnur/mjqXmlLbmlofku7YiLAogICJzdGFydF91cmwiOiAiLi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMzNDk4ZGIiLAogICJ0aGVtZV9jb2xvciI6ICIjMzQ5OGRiIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFNQUFBQUFEQUNBWUFBQUE2L1E4RmdBQUFBWGtTVVJCVkhqYTdkMEJDQUF3QUlQLy93QUFBQUFTVVZPUks1Q1lJST0iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    
    <!-- æœ¬åœ°ä¾èµ–åº“ -->
    <script src="js/pako.min.js"></script>
    <script src="js/localforage.min.js"></script>
    
    <!-- ä½¿ç”¨æœ€æ–°çš„ ZXing 0.21.3 åº“ -->
    <script src="js/index.min.js"></script>
    
    <!-- æ ·å¼éƒ¨åˆ† -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }
        .header {
            text-align: center;
            padding: 20px 0;
        }
        .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: #333;
            backdrop-filter: blur(10px);
        }
        .section-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* æ‰«æçª—å£æ ·å¼ */
        .scan-section {
            display: none;
            position: relative;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
        }
        .scan-section.active {
            display: block;
        }
        .scan-window {
            width: 100%;
            background: #000;
            position: relative;
            padding-top: 100%;
        }
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        #videoElement {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 3px solid #3498db;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.6);
            animation: scan-pulse 2s infinite;
        }
        @keyframes scan-pulse {
            0% { border-color: #3498db; }
            50% { border-color: #2ecc71; }
            100% { border-color: #3498db; }
        }
        .scan-success .scan-frame {
            border-color: #2ecc71 !important;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.6), 0 0 20px rgba(46, 204, 113, 0.5) !important;
            animation: none !important;
        }
        /* å…³é—­æŒ‰é’® */
        .scan-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(231, 76, 60, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .scan-close-btn:hover {
            background: rgba(192, 57, 43, 0.9);
            transform: scale(1.1);
        }
        /* æ‰«ææç¤º */
        .scan-tips {
            background: rgba(52, 152, 219, 0.9);
            color: white;
            text-align: center;
            padding: 10px 15px;
            border-radius: 0 0 15px 15px;
        }
        .scan-tips p {
            margin: 3px 0;
            font-size: 14px;
        }
        /* æµ®åŠ¨æç¤º */
        .floating-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(46, 204, 113, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.5);
            animation: floatUp 1.5s ease forwards;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 80%;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, -30%); }
            20% { opacity: 1; transform: translate(-50%, -50%); }
            80% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -70%); }
        }
        .floating-error {
            background: rgba(231, 76, 60, 0.95);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.5);
        }
        /* çŠ¶æ€å’Œä¿¡æ¯æ ·å¼ */
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            transition: all 0.3s;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .progress-section {
            margin: 20px 0;
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .progress-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        .file-info {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .action-buttons .btn {
            flex: 1;
        }
        .hidden {
            display: none !important;
        }
        .camera-selector {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 100%;
            background: white;
        }
        .manual-input-section textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
            resize: vertical;
            background: #f8f9fa;
        }
        .footer {
            text-align: center;
            margin: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }
        /* åˆ†ç‰‡æ˜¾ç¤ºæ ·å¼ */
        .chunks-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-top: 15px;
        }
        .chunk-item {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s;
        }
        .chunk-received {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            box-shadow: 0 2px 4px rgba(46, 204, 113, 0.3);
            animation: chunk-pop 0.3s ease;
        }
        @keyframes chunk-pop {
            0% { transform: scale(0.8); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .chunk-missing {
            background: #ecf0f1;
            color: #7f8c8d;
        }
        .chunk-filename {
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }
        /* æŒ‡çº¹æ˜¾ç¤º */
        .fingerprint-display {
            padding: 8px 12px;
            background: linear-gradient(135deg, #e8f4fc, #d6eaf8);
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            text-align: center;
            border: 1px solid #3498db;
        }
        @media (max-width: 480px) {
            .chunk-item {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            .btn {
                padding: 12px;
                font-size: 15px;
            }
        }
        @media (min-width: 768px) {
            .app-container {
                max-width: 500px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo">ğŸ“±</div>
            <h1>äºŒç»´ç æ–‡ä»¶æ¥æ”¶å™¨ - V1.0</h1>
            <p class="subtitle"></p>
        </div>

        <!-- æµ®åŠ¨æç¤ºå®¹å™¨ -->
        <div id="floatingContainer"></div>
        
        <!-- æ‰«æçª—å£ -->
        <div id="scanSection" class="scan-section">
            <div class="scan-window">
                <button id="closeScanBtn" class="scan-close-btn">Ã—</button>
                <div class="video-container">
                    <video id="videoElement" playsinline></video>
                    <div class="scan-overlay">
                        <div class="scan-frame"></div>
                    </div>
                </div>
            </div>
            <div class="scan-tips">
                <p>æ­£æ–¹å½¢æ‰«æçª—å£ | ZXing 0.21.3 æœ€æ–°ç‰ˆ</p>
                <p>å…ˆæ‰«ææ•°æ®äºŒç»´ç ï¼Œæœ€åæ‰«ææ–‡ä»¶åäºŒç»´ç </p>
            </div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ“· 1. æ‰«æè®¾ç½®</div>
            
            <select id="cameraSelect" class="camera-selector">
                <option value="">é€‰æ‹©æ‘„åƒå¤´...</option>
            </select>
            
            <button id="startScanBtn" class="btn btn-primary">
                <span id="scanBtnText">ğŸš€ å¼€å§‹æ‰«æäºŒç»´ç </span>
                <div id="scanStatus" class="focus-status">å‡†å¤‡å°±ç»ª</div>
            </button>
            
            <div class="manual-input-section">
                <p style="color: #666; margin: 15px 0 10px; font-size: 14px;">å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨è¾“å…¥</p>
                <textarea id="manualData" placeholder='ç²˜è´´äºŒç»´ç å†…å®¹ï¼Œä¾‹å¦‚ï¼š{"i":0,"t":5,"f":"abc12","h":"xyz89","d":"..."} æˆ– {"t":"fn","f":"abc12","n":"JUU5JTlGJUE5JUU4JUE2JTgxJUU1JThGJUIwJUU5JTgxJTk1JUU5JTlBJUIxJUU3JTg5JTg4LnR4dA==","s":1024}'></textarea>
                <button id="submitManualBtn" class="btn btn-primary">
                    âœ… æäº¤æ•°æ®
                </button>
            </div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ“Š 2. æ¥æ”¶è¿›åº¦</div>
            
            <div id="currentFingerprint" class="fingerprint-display" style="display: none;">
                <strong>å½“å‰æ–‡ä»¶æŒ‡çº¹:</strong> <span id="fingerprintValue">æœªè®¾ç½®</span>
            </div>
            
            <div id="status" class="status-message status-info">
                ç­‰å¾…æ‰«æç¬¬ä¸€ä¸ªäºŒç»´ç ...
            </div>
            
            <div class="progress-section">
                <div class="progress-info">
                    <span>è¿›åº¦: <span id="receivedCount">0</span>/<span id="totalCount">0</span></span>
                    <span id="percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
            
            <div id="chunksDisplay" class="chunks-grid">
                <!-- åˆ†ç‰‡çŠ¶æ€ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ’¾ 3. æ–‡ä»¶ä¿¡æ¯</div>
            
            <div id="fileInfo" class="file-info">
                <p><strong>æ–‡ä»¶å:</strong> <span id="fileName">æœªçŸ¥</span></p>
                <p><strong>æ–‡ä»¶å¤§å°:</strong> <span id="fileSize">æœªçŸ¥</span></p>
                <p><strong>æ–‡ä»¶ç±»å‹:</strong> <span id="fileType">æœªçŸ¥</span></p>
                <p><strong>æ¥æ”¶æ—¶é—´:</strong> <span id="receiveTime">æœªçŸ¥</span></p>
                <p><strong>æ€»æ•°æ®åˆ†ç‰‡:</strong> <span id="dataChunksCount">0</span></p>
            </div>
            
            <div class="action-buttons">
                <button id="assembleBtn" class="btn btn-success" disabled>
                    <span id="assembleBtnText">ğŸ› ï¸ é‡ç»„æ–‡ä»¶</span>
                </button>
                <button id="clearBtn" class="btn btn-danger">
                    ğŸ—‘ï¸ æ¸…é™¤æ•°æ®
                </button>
            </div>
            
            <div id="downloadSection" class="hidden" style="margin-top: 15px;">
                <button id="downloadBtn" class="btn btn-primary">
                    â¬‡ï¸ ä¸‹è½½æ–‡ä»¶
                </button>
            </div>
        </div>

        <div class="footer">
            <p>ğŸ’¡ æé†’ï¼šæ–‡ä»¶ååœ¨æœ€åä¸€ä¸ªå•ç‹¬çš„äºŒç»´ç ä¸­</p>
            <p>æ–‡ä»¶åç»è¿‡Base64ç¼–ç ï¼Œæ”¯æŒä¸­æ–‡</p>
        </div>
    </div>

    <!-- JavaScript ä»£ç  -->
    <script>
        // çŠ¶æ€å˜é‡
        let receivedDataChunks = new Map(); // æ•°æ®åˆ†ç‰‡
        let fileNameData = null; // æ–‡ä»¶åæ•°æ®
        let totalDataChunks = 0; // æ•°æ®åˆ†ç‰‡æ€»æ•°
        let currentFileFingerprint = null;
        let isProcessing = false;
        let receivedFileName = '';
        let receivedFileSize = 0;
        let isScanning = false;
        let codeReader = null;
        let scanControls = null;
        let lastDecodedText = '';
        let lastScanTime = 0;
        let scanCount = 0; // æ‰«æè®¡æ•°å™¨
        
        // å‘é€ç«¯ä½¿ç”¨çš„CRC32è®¡ç®—å‡½æ•°ï¼ˆä¸å‘é€ç«¯ä¿æŒä¸€è‡´ï¼‰
        function calculateCRC32(data) {
            // ä¼˜å…ˆä½¿ç”¨pakoçš„crc32å‡½æ•°ç¡®ä¿ä¸€è‡´æ€§
            if (typeof pako !== 'undefined' && pako.crc32) {
                const crc = pako.crc32(data);
                return crc.toString(36).padStart(5, '0').slice(-5);
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šç¡®ä¿ä¸å‘é€ç«¯ä¸€è‡´çš„å®ç°
            return calculateCRC32Fallback(data);
        }

        // CRC32å¤‡ç”¨å®ç°ï¼ˆç¡®ä¿ä¸å‘é€ç«¯ä¸€è‡´ï¼‰
        function calculateCRC32Fallback(data) {
            const table = new Uint32Array(256);
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) {
                    c = (c & 1) ? 0xEDB88320 ^ (c >>> 1) : c >>> 1;
                }
                table[i] = c;
            }
            
            let crc = 0xFFFFFFFF;
            const len = data.length;
            
            for (let i = 0; i < len; i++) {
                crc = (crc >>> 8) ^ table[(crc ^ data.charCodeAt(i)) & 0xFF];
            }
            crc = (crc ^ 0xFFFFFFFF) >>> 0;
            return crc.toString(36).padStart(5, '0').slice(-5);
        }

        // Base64è§£ç æ–‡ä»¶åï¼ˆå¤„ç†å‘é€ç«¯çš„ç¼–ç ï¼‰
        function decodeFileName(base64Name) {
            try {
                // å‘é€ç«¯ä½¿ç”¨TextEncoderç¼–ç ï¼Œè¿™é‡Œéœ€è¦æ­£ç¡®è§£ç 
                const binaryStr = atob(base64Name);
                const bytes = new Uint8Array(binaryStr.length);
                for (let i = 0; i < binaryStr.length; i++) {
                    bytes[i] = binaryStr.charCodeAt(i);
                }
                const decoder = new TextDecoder('utf-8');
                return decoder.decode(bytes);
            } catch (e) {
                console.error('æ–‡ä»¶åè§£ç å¤±è´¥:', e);
                try {
                    // å¤‡ç”¨è§£ç æ–¹å¼
                    return decodeURIComponent(atob(base64Name));
                } catch (e2) {
                    console.error('å¤‡ç”¨è§£ç ä¹Ÿå¤±è´¥:', e2);
                    return base64Name; // å¦‚æœè§£ç å¤±è´¥ï¼Œè¿”å›åŸå§‹å€¼
                }
            }
        }

        // DOMå…ƒç´ 
        const videoElement = document.getElementById('videoElement');
        const cameraSelect = document.getElementById('cameraSelect');
        const startScanBtn = document.getElementById('startScanBtn');
        const scanBtnText = document.getElementById('scanBtnText');
        const scanStatus = document.getElementById('scanStatus');
        const scanSection = document.getElementById('scanSection');
        const closeScanBtn = document.getElementById('closeScanBtn');
        const status = document.getElementById('status');
        const receivedCount = document.getElementById('receivedCount');
        const totalCount = document.getElementById('totalCount');
        const percentage = document.getElementById('percentage');
        const progressFill = document.getElementById('progressFill');
        const chunksDisplay = document.getElementById('chunksDisplay');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileType = document.getElementById('fileType');
        const receiveTime = document.getElementById('receiveTime');
        const dataChunksCount = document.getElementById('dataChunksCount');
        const assembleBtn = document.getElementById('assembleBtn');
        const assembleBtnText = document.getElementById('assembleBtnText');
        const clearBtn = document.getElementById('clearBtn');
        const downloadSection = document.getElementById('downloadSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const manualData = document.getElementById('manualData');
        const submitManualBtn = document.getElementById('submitManualBtn');
        const floatingContainer = document.getElementById('floatingContainer');
        const currentFingerprint = document.getElementById('currentFingerprint');
        const fingerprintValue = document.getElementById('fingerprintValue');

        // ä½¿ç”¨ ZXing
        const { BrowserQRCodeReader } = ZXing;

        // æ˜¾ç¤ºæµ®åŠ¨æ¶ˆæ¯
        function showFloatingMessage(message, isError = false) {
            const floatingMsg = document.createElement('div');
            floatingMsg.className = `floating-message ${isError ? 'floating-error' : ''}`;
            floatingMsg.textContent = message;
            floatingContainer.appendChild(floatingMsg);
            
            setTimeout(() => {
                if (floatingMsg.parentNode) {
                    floatingMsg.parentNode.removeChild(floatingMsg);
                }
            }, 1500);
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('äºŒç»´ç æ¥æ”¶å™¨ - åˆ†ç¦»æ–‡ä»¶åç‰ˆæœ¬åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥ZXingåº“
            if (typeof ZXing === 'undefined' || !BrowserQRCodeReader) {
                showStatus('ZXingåº“åŠ è½½å¤±è´¥', 'error');
                startScanBtn.disabled = true;
                scanBtnText.textContent = 'åº“åŠ è½½å¤±è´¥';
                scanStatus.textContent = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                return;
            }
            
            console.log('âœ… ZXingåº“åŠ è½½æˆåŠŸ');
            scanStatus.textContent = 'å°±ç»ªï¼Œä½¿ç”¨æœ€æ–°ç‰ˆZXing';
            
            // åˆå§‹åŒ–æ‘„åƒå¤´åˆ—è¡¨
            await initCameraList();
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            await loadSavedChunks();
            updateUI();
            
            showStatus('å‡†å¤‡å°±ç»ªï¼Œè¯·ç‚¹å‡»å¼€å§‹æ‰«æ', 'info');
        });

        // åˆå§‹åŒ–æ‘„åƒå¤´åˆ—è¡¨
        async function initCameraList() {
            try {
                console.log('æ­£åœ¨æ£€æµ‹æ‘„åƒå¤´...');
                scanStatus.textContent = 'æ­£åœ¨æ£€æµ‹æ‘„åƒå¤´...';

                let videoInputDevices = [];
                
                try {
                    videoInputDevices = await BrowserQRCodeReader.listVideoInputDevices();
                    console.log(`âœ… é€šè¿‡ZXing APIæ‰¾åˆ° ${videoInputDevices.length} ä¸ªæ‘„åƒå¤´`);
                } catch (zxingEnumErr) {
                    console.warn('ZXingæšä¸¾è®¾å¤‡å¤±è´¥ï¼Œå°è¯•åŸç”ŸAPI');
                    
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    videoInputDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log(`âœ… é€šè¿‡åŸç”ŸAPIæ‰¾åˆ° ${videoInputDevices.length} ä¸ªæ‘„åƒå¤´`);
                }

                cameraSelect.innerHTML = '<option value="">é€‰æ‹©æ‘„åƒå¤´...</option>';
                
                if (videoInputDevices.length > 0) {
                    videoInputDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `æ‘„åƒå¤´ ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    scanStatus.textContent = `æ‰¾åˆ° ${videoInputDevices.length} ä¸ªæ‘„åƒå¤´`;
                    
                    const rearCamera = videoInputDevices.find(d => 
                        d.label && (
                            d.label.toLowerCase().includes('rear') || 
                            d.label.toLowerCase().includes('back') ||
                            d.label.includes('åç½®')
                        )
                    );
                    if (rearCamera) {
                        cameraSelect.value = rearCamera.deviceId;
                        console.log('è‡ªåŠ¨é€‰æ‹©åç½®æ‘„åƒå¤´:', rearCamera.label);
                    } else if (videoInputDevices.length === 1) {
                        cameraSelect.value = videoInputDevices[0].deviceId;
                    }
                    
                } else {
                    console.log('æœªæ‰¾åˆ°ä»»ä½•æ‘„åƒå¤´è®¾å¤‡');
                    scanStatus.textContent = 'æœªæ‰¾åˆ°æ‘„åƒå¤´';
                    cameraSelect.innerHTML = '<option value="">æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡</option>';
                    showStatus('æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡ã€‚è¯·æ£€æŸ¥è®¾å¤‡è¿æ¥æˆ–æƒé™ã€‚', 'error');
                }
                
            } catch (err) {
                console.error('åˆå§‹åŒ–æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', err);
                scanStatus.textContent = 'æ‘„åƒå¤´æ£€æµ‹å¤±è´¥';
                cameraSelect.innerHTML = '<option value="">æ£€æµ‹å¤±è´¥ï¼Œç‚¹å‡»æ‰«ææŒ‰é’®é‡è¯•</option>';
                
                let errorMsg = 'æ£€æµ‹æ‘„åƒå¤´å¤±è´¥: ';
                if (err.name === 'NotAllowedError') {
                    errorMsg += 'ç”¨æˆ·æ‹’ç»äº†æ‘„åƒå¤´æƒé™ã€‚';
                } else if (err.name === 'NotFoundError') {
                    errorMsg += 'æœªæ‰¾åˆ°æ‘„åƒå¤´ç¡¬ä»¶ã€‚';
                } else if (err.name === 'NotReadableError') {
                    errorMsg += 'æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚';
                } else {
                    errorMsg += err.message;
                }
                showStatus(errorMsg, 'error');
                
                startScanBtn.disabled = false;
                scanBtnText.textContent = 'ğŸš€ å°è¯•æ‰«æ (æƒé™æ£€æµ‹å¤±è´¥)';
            }
        }

        // å¯åŠ¨æ‰«æ
        startScanBtn.addEventListener('click', async () => {
            console.log('ç‚¹å‡»å¼€å§‹æ‰«ææŒ‰é’®');
            
            if (isProcessing) {
                console.log('æ­£åœ¨å¤„ç†ä¸­ï¼Œå¿½ç•¥ç‚¹å‡»');
                return;
            }
            
            if (isScanning) {
                await stopScanning();
                return;
            }
            
            isProcessing = true;
            
            try {
                startScanBtn.disabled = true;
                scanBtnText.textContent = 'â³ å¯åŠ¨ä¸­...';
                scanStatus.textContent = 'æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...';
                
                scanSection.classList.add('active');
                
                const deviceId = cameraSelect.value || undefined;
                console.log('ä½¿ç”¨æ‘„åƒå¤´è®¾å¤‡ID:', deviceId || 'é»˜è®¤');
                
                codeReader = new BrowserQRCodeReader({
                    tryHarder: true,
                    formats: [ZXing.BarcodeFormat.QR_CODE]
                });
                
                console.log('äºŒç»´ç è§£ç å™¨åˆ›å»ºæˆåŠŸ');
                
                scanControls = await codeReader.decodeFromVideoDevice(
                    deviceId,
                    videoElement,
                    (result, error, controls) => {
                        if (result) {
                            const decodedText = result.getText();
                            handleScanResult(decodedText);
                        }
                        if (error) {
                            if (!error.message || 
                                (!error.message.includes('NotFound') && 
                                 !error.message.includes('No QR'))) {
                                console.log('è§£ç è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                            }
                        }
                        if (controls && !scanControls) {
                            scanControls = controls;
                        }
                    }
                );
                
                isScanning = true;
                
                startScanBtn.disabled = false;
                scanBtnText.textContent = 'â¹ï¸ åœæ­¢æ‰«æ';
                scanStatus.textContent = 'æ‰«æä¸­... è¯·å¯¹å‡†äºŒç»´ç ';
                showStatus('æ‰«æå·²å¯åŠ¨ï¼Œè¯·å¯¹å‡†äºŒç»´ç ', 'success');
                showFloatingMessage('ğŸ“· æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œå¼€å§‹æ‰«æ');
                
                console.log('âœ… æ‰«æå¯åŠ¨æˆåŠŸ');
                
            } catch (err) {
                console.error('å¯åŠ¨æ‰«æå¤±è´¥:', err);
                
                if (err.name === 'NotAllowedError') {
                    showStatus('âŒ è¯·å…è®¸æ‘„åƒå¤´æƒé™', 'error');
                    showFloatingMessage('âš ï¸ è¯·å…è®¸æ‘„åƒå¤´æƒé™', true);
                    scanStatus.textContent = 'éœ€è¦æ‘„åƒå¤´æƒé™';
                } else if (err.name === 'NotFoundError') {
                    showStatus('âŒ æœªæ‰¾åˆ°æ‘„åƒå¤´', 'error');
                    scanStatus.textContent = 'æœªæ‰¾åˆ°æ‘„åƒå¤´';
                } else {
                    showStatus('âŒ å¯åŠ¨å¤±è´¥: ' + err.message, 'error');
                    scanStatus.textContent = 'å¯åŠ¨å¤±è´¥';
                }
                
                await stopScanning();
                startScanBtn.disabled = false;
                scanBtnText.textContent = 'ğŸš€ å¼€å§‹æ‰«æäºŒç»´ç ';
                
            } finally {
                isProcessing = false;
            }
        });

        // å¤„ç†æ‰«æç»“æœ
function handleScanResult(decodedText) {
    const now = Date.now();
    
    if (now - lastScanTime < 1000 && decodedText === lastDecodedText) {
        console.log('è·³è¿‡é‡å¤çš„æ‰«æç»“æœ');
        return;
    }
    
    lastScanTime = now;
    lastDecodedText = decodedText;
    
    console.log('è§£ç æˆåŠŸ:', decodedText.substring(0, 100) + '...');
    
    scanSection.classList.add('scan-success');
    setTimeout(() => {
        scanSection.classList.remove('scan-success');
    }, 300);
    
    processChunkData(decodedText);
    
    scanStatus.textContent = 'âœ… è§£ç æˆåŠŸ';
    // ä¸å†æ˜¾ç¤ºæµ®åŠ¨æ¶ˆæ¯ï¼Œç”±processChunkDataå‡½æ•°å†…éƒ¨æ˜¾ç¤ºå…·ä½“ä¿¡æ¯
}

        // åœæ­¢æ‰«æ
        async function stopScanning() {
            console.log('åœæ­¢æ‰«æ');
            
            isScanning = false;
            lastDecodedText = '';
            scanCount = 0;
            
            if (scanControls && scanControls.stop) {
                scanControls.stop();
                console.log('å·²åœæ­¢è§£ç å¾ªç¯');
            }
            
            if (codeReader && codeReader.reset) {
                codeReader.reset();
                console.log('å·²é‡ç½®è§£ç å™¨');
            }
            
            if (videoElement.srcObject) {
                const stream = videoElement.srcObject;
                stream.getTracks().forEach(track => {
                    track.stop();
                    console.log('åœæ­¢è½¨é“:', track.kind);
                });
                videoElement.srcObject = null;
            }
            
            scanControls = null;
            codeReader = null;
            
            scanSection.classList.remove('active');
            
            scanBtnText.textContent = 'ğŸš€ å¼€å§‹æ‰«æäºŒç»´ç ';
            scanStatus.textContent = 'å·²åœæ­¢';
            startScanBtn.disabled = false;
            
            console.log('æ‰«æå·²å®Œå…¨åœæ­¢');
            showStatus('æ‰«æå·²åœæ­¢', 'info');
            showFloatingMessage('â¹ï¸ æ‰«æå·²åœæ­¢');
        }

        // å…³é—­æ‰«ææŒ‰é’®äº‹ä»¶
        closeScanBtn.addEventListener('click', () => {
            stopScanning();
        });

        // å¤„ç†æ‰«æåˆ°çš„æ•°æ®
 async function processChunkData(data) {
    console.log('å¤„ç†æ•°æ®é•¿åº¦:', data.length);
    
    try {
        // 1. æ•°æ®æ¸…æ´—
        let trimmed = data.trim();
        
        if (!trimmed.startsWith('{') && trimmed.includes('{')) {
            const braceIndex = trimmed.indexOf('{');
            trimmed = trimmed.substring(braceIndex);
        }
        
        if (!trimmed.endsWith('}') && trimmed.includes('}')) {
            const braceIndex = trimmed.lastIndexOf('}');
            trimmed = trimmed.substring(0, braceIndex + 1);
        }
        
        if (!trimmed.startsWith('{') || !trimmed.endsWith('}')) {
            throw new Error('æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼');
        }
        
        // 2. JSONè§£æ
        let chunk;
        try {
            chunk = JSON.parse(trimmed);
            console.log('âœ… JSONè§£ææˆåŠŸï¼ç±»å‹:', chunk.t || 'data');
        } catch (parseErr) {
            throw new Error('JSONè§£æå¤±è´¥: ' + parseErr.message);
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡ä»¶åäºŒç»´ç 
        if (chunk.t === 'fn') {
            // å¤„ç†æ–‡ä»¶åäºŒç»´ç 
            console.log('ğŸ“„ å¤„ç†æ–‡ä»¶åäºŒç»´ç ');
            
            // æ£€æŸ¥å¿…éœ€å­—æ®µ
            if (typeof chunk.f !== 'string' || typeof chunk.n !== 'string' || 
                typeof chunk.s !== 'number' || typeof chunk.h !== 'string') {
                throw new Error('æ–‡ä»¶åæ•°æ®å­—æ®µæ ¼å¼é”™è¯¯');
            }
            
            // CRC32æ ¡éªŒ - ä½¿ç”¨ä¸å‘é€ç«¯ç›¸åŒçš„æ–¹å¼è®¡ç®—
            // æ³¨æ„ï¼šå‘é€ç«¯å¯¹æ–‡ä»¶åäºŒç»´ç çš„CRC32è®¡ç®—ä¸åŒ…æ‹¬hå­—æ®µ
            const crcData = {
                t: chunk.t,
                f: chunk.f,
                n: chunk.n,  // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨Base64ç¼–ç çš„æ–‡ä»¶å
                s: chunk.s,
                ts: chunk.ts,
                tc: chunk.tc
            };
            const jsonStr = JSON.stringify(crcData);
            const calculatedHash = calculateCRC32(jsonStr);
            const hashMatch = calculatedHash === chunk.h.toLowerCase();
            
            if (!hashMatch) {
                console.warn(`æ–‡ä»¶åæ ¡éªŒå¤±è´¥: è®¡ç®—å€¼=${calculatedHash}, æ¥æ”¶å€¼=${chunk.h}`);
                showFloatingMessage('âŒ æ–‡ä»¶åæ ¡éªŒå¤±è´¥', true);
                return;
            }
            
            // æ–‡ä»¶æŒ‡çº¹æ£€æŸ¥
            if (currentFileFingerprint && chunk.f !== currentFileFingerprint) {
                showFloatingMessage('âš ï¸ æ–‡ä»¶æŒ‡çº¹ä¸åŒ¹é…', true);
                return;
            }
            
            // å­˜å‚¨æ–‡ä»¶åæ•°æ®
            fileNameData = chunk;
            
            // è§£ç æ–‡ä»¶åï¼ˆBase64 -> åŸå§‹æ–‡ä»¶åï¼‰
            try {
                receivedFileName = decodeFileName(chunk.n);
                console.log('âœ… æ–‡ä»¶åè§£ç æˆåŠŸ:', receivedFileName);
            } catch (decodeError) {
                console.error('æ–‡ä»¶åè§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å€¼:', decodeError);
                receivedFileName = chunk.n;
            }
            
            // æ›´æ–°ä¿¡æ¯
            if (!currentFileFingerprint) {
                currentFileFingerprint = chunk.f;
                fingerprintValue.textContent = currentFileFingerprint;
                currentFingerprint.style.display = 'block';
            }
            
            // è®¾ç½®æ€»åˆ†ç‰‡æ•°
            if (chunk.tc && chunk.tc > 0) {
                totalDataChunks = chunk.tc;
            }
            
            receivedFileSize = chunk.s;
            
            // å­˜å‚¨åˆ°æœ¬åœ°
             try {
        const store = localforage.createInstance({ name: 'qrcode-filename-separate' });
        await store.setItem('fileNameData', fileNameData);
        await store.setItem('fileName', receivedFileName);
        await store.setItem('fileSize', receivedFileSize);
        await store.setItem('totalDataChunks', totalDataChunks);
        // ä¿å­˜æ¥æ”¶æ—¶é—´
        await store.setItem('receiveTime', new Date().toISOString());
        console.log('âœ… æ–‡ä»¶åæ•°æ®å·²ä¿å­˜');
    } catch (storeErr) {
        console.error('æ–‡ä»¶åæ•°æ®å­˜å‚¨å¤±è´¥:', storeErr);
    }
    
    // ç«‹å³æ›´æ–°æ¥æ”¶æ—¶é—´æ˜¾ç¤º
    receiveTime.textContent = new Date().toLocaleString();
    
    showFloatingMessage('ğŸ“„ æ–‡ä»¶ååˆ†ç‰‡æ‰«ææˆåŠŸ');
    showStatus(`âœ… æ–‡ä»¶åæ¥æ”¶: ${receivedFileName}`, 'success');

            
        } else {
            // å¤„ç†æ•°æ®äºŒç»´ç 
            console.log('å¤„ç†æ•°æ®äºŒç»´ç ');
            
            // æ£€æŸ¥å¿…éœ€å­—æ®µ
            if (typeof chunk.i !== 'number' || typeof chunk.t !== 'number' || 
                typeof chunk.h !== 'string' || typeof chunk.d !== 'string' ||
                typeof chunk.f !== 'string') {
                throw new Error('æ•°æ®äºŒç»´ç å­—æ®µæ ¼å¼é”™è¯¯');
            }
            
            // æ–‡ä»¶æŒ‡çº¹æ£€æŸ¥
            if (!currentFileFingerprint) {
                // é¦–æ¬¡æ¥æ”¶æ•°æ®ï¼Œè®¾ç½®æ–‡ä»¶æŒ‡çº¹
                currentFileFingerprint = chunk.f;
                fingerprintValue.textContent = currentFileFingerprint;
                currentFingerprint.style.display = 'block';
                console.log('ğŸ†” æ–°æ–‡ä»¶æŒ‡çº¹:', currentFileFingerprint);
                showStatus(`å¼€å§‹æ¥æ”¶æ–°æ–‡ä»¶ (${chunk.t}ä¸ªæ•°æ®åˆ†ç‰‡)`, 'info');
            } else if (chunk.f !== currentFileFingerprint) {
                showFloatingMessage('âš ï¸ äºŒç»´ç ä¸å±äºå½“å‰æ–‡ä»¶', true);
                return;
            }
            
            // CRC32æ ¡éªŒ - å¯¹æ•°æ®å­—æ®µè¿›è¡Œæ ¡éªŒï¼ˆä¸å‘é€ç«¯ä¸€è‡´ï¼‰
            const calculatedHash = calculateCRC32(chunk.d);
            const hashMatch = calculatedHash === chunk.h.toLowerCase();
            
            if (!hashMatch) {
                console.warn(`æ•°æ®åˆ†ç‰‡ ${chunk.i+1} æ ¡éªŒå¤±è´¥: è®¡ç®—å€¼=${calculatedHash}, æ¥æ”¶å€¼=${chunk.h}`);
                showFloatingMessage(`âŒ åˆ†ç‰‡ ${chunk.i+1} æ ¡éªŒå¤±è´¥`, true);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é‡å¤
            if (receivedDataChunks.has(chunk.i)) {
                console.log('åˆ†ç‰‡å·²æ¥æ”¶è¿‡');
                showFloatingMessage(`âš ï¸ åˆ†ç‰‡ ${chunk.i+1}/${chunk.t} å·²æ¥æ”¶è¿‡`);
                return;
            }
            
            // æ›´æ–°æ€»åˆ†ç‰‡æ•°
            if (totalDataChunks === 0) {
                totalDataChunks = chunk.t;
            }
            
            // å­˜å‚¨åˆ†ç‰‡
            receivedDataChunks.set(chunk.i, chunk);
            
            // å­˜å‚¨åˆ°æœ¬åœ°
            try {
                const store = localforage.createInstance({ name: 'qrcode-filename-separate' });
                await store.setItem(`dataChunk_${chunk.i}`, chunk);
                console.log('âœ… æ•°æ®åˆ†ç‰‡å­˜å‚¨æˆåŠŸ');
            } catch (storageErr) {
                console.error('æ•°æ®åˆ†ç‰‡å­˜å‚¨å¤±è´¥:', storageErr);
            }
            
            // ä¿®æ”¹è¿™é‡Œï¼šæ˜¾ç¤ºæ•°æ®åˆ†ç‰‡ x/y æ‰«ææˆåŠŸ
            showFloatingMessage(`âœ… æ•°æ®åˆ†ç‰‡ ${chunk.i + 1}/${chunk.t} æ‰«ææˆåŠŸ`);
            showStatus(`âœ… æˆåŠŸæ¥æ”¶æ•°æ®åˆ†ç‰‡ ${chunk.i + 1}/${totalDataChunks}`, 'success');
        }
        
        // æ›´æ–°UI
        updateUI();
        
        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
        checkCompletion();
        
    } catch (err) {
        console.error('å¤„ç†æ•°æ®å¤±è´¥:', err);
        showFloatingMessage('âŒ å¤„ç†å¤±è´¥', true);
    }
}


        // æ£€æŸ¥æ˜¯å¦å®Œæˆæ¥æ”¶
        function checkCompletion() {
            if (fileNameData && totalDataChunks > 0 && 
                receivedDataChunks.size >= totalDataChunks) {
                console.log('ğŸŠ æ‰€æœ‰æ•°æ®åˆ†ç‰‡å’Œæ–‡ä»¶åéƒ½å·²æ¥æ”¶å®Œæˆï¼');
                assembleBtn.disabled = false;
                showStatus('âœ… æ‰€æœ‰åˆ†ç‰‡æ¥æ”¶å®Œæˆï¼ç‚¹å‡»é‡ç»„æ–‡ä»¶æŒ‰é’®', 'success');
                showFloatingMessage('ğŸ‰ æ¥æ”¶å®Œæˆï¼');
                
                setTimeout(() => stopScanning(), 500);
            }
        }

        // æ‰‹åŠ¨æäº¤
submitManualBtn.addEventListener('click', () => {
    const data = manualData.value.trim();
    if (data) {
        showFloatingMessage('âœ… æ‰‹åŠ¨æäº¤æˆåŠŸ');
        processChunkData(data);
        manualData.value = '';
    } else {
        showStatus('è¯·è¾“å…¥äºŒç»´ç æ•°æ®', 'error');
    }
});

        // ä»å­˜å‚¨åŠ è½½æ•°æ®
        // ä»å­˜å‚¨åŠ è½½æ•°æ®
async function loadSavedChunks() {
    try {
        const store = localforage.createInstance({ name: 'qrcode-filename-separate' });
        const keys = await store.keys();
        
        // åŠ è½½æ–‡ä»¶åæ•°æ®
        const savedFileNameData = await store.getItem('fileNameData');
        if (savedFileNameData) {
            fileNameData = savedFileNameData;
            
            // è§£ç ä¿å­˜çš„æ–‡ä»¶å
            try {
                receivedFileName = decodeFileName(fileNameData.n);
            } catch (decodeErr) {
                receivedFileName = fileNameData.n;
            }
            
            receivedFileSize = fileNameData.s;
            currentFileFingerprint = fileNameData.f;
            totalDataChunks = fileNameData.tc || 0;
            
            fingerprintValue.textContent = currentFileFingerprint;
            currentFingerprint.style.display = 'block';
            
            // åŠ è½½ä¿å­˜çš„æ¥æ”¶æ—¶é—´
            const savedReceiveTime = await store.getItem('receiveTime');
            if (savedReceiveTime) {
                // å°†ISOå­—ç¬¦ä¸²è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´æ ¼å¼
                const date = new Date(savedReceiveTime);
                receiveTime.textContent = date.toLocaleString();
            } else {
                receiveTime.textContent = new Date().toLocaleString();
            }
        }
        
        // åŠ è½½æ•°æ®åˆ†ç‰‡
        for (const key of keys) {
            if (key.startsWith('dataChunk_')) {
                const id = parseInt(key.replace('dataChunk_', ''));
                const chunk = await store.getItem(key);
                if (chunk) {
                    receivedDataChunks.set(id, chunk);
                }
            }
        }
        
        console.log('ä»å­˜å‚¨åŠ è½½äº†', receivedDataChunks.size, 'ä¸ªæ•°æ®åˆ†ç‰‡');
        if (receivedFileName) {
            console.log('å·²åŠ è½½æ–‡ä»¶å:', receivedFileName);
        }
        
    } catch (err) {
        console.error('åŠ è½½å­˜å‚¨å¤±è´¥:', err);
    }
}

        // æ›´æ–°UI
        // æ›´æ–°UI
function updateUI() {
    const totalReceived = receivedDataChunks.size + (fileNameData ? 1 : 0);
    const totalToReceive = totalDataChunks + 1; // æ•°æ®åˆ†ç‰‡ + æ–‡ä»¶åäºŒç»´ç 
    
    receivedCount.textContent = totalReceived;
    totalCount.textContent = totalToReceive;
    
    const percent = totalToReceive > 0 ? Math.round((totalReceived / totalToReceive) * 100) : 0;
    percentage.textContent = percent + '%';
    progressFill.style.width = percent + '%';
    
    updateChunksDisplay();
    
    // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
    if (fileNameData) {
        fileName.textContent = receivedFileName;
        fileSize.textContent = formatFileSize(fileNameData.s);
        fileType.textContent = getFileTypeFromName(receivedFileName);
        dataChunksCount.textContent = totalDataChunks;
        
        // è®¾ç½®æ¥æ”¶æ—¶é—´ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è®¾ç½®çš„è¯ï¼‰
        if (receiveTime.textContent === 'æœªçŸ¥') {
            receiveTime.textContent = new Date().toLocaleString();
        }
        
        fileInfo.style.display = 'block';
    }
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    if (fileNameData && currentFileFingerprint) {
        const shortName = receivedFileName.length > 25 ? 
            receivedFileName.substring(0, 25) + '...' : 
            receivedFileName;
        document.getElementById('status').innerHTML = 
            `<strong>${shortName}</strong> - æ•°æ®: ${receivedDataChunks.size}/${totalDataChunks}`;
    }
    
    // æ£€æŸ¥é‡ç»„æŒ‰é’®çŠ¶æ€
    assembleBtn.disabled = !(fileNameData && totalDataChunks > 0 && 
        receivedDataChunks.size >= totalDataChunks);
}

        // æ›´æ–°åˆ†ç‰‡æ˜¾ç¤º
        function updateChunksDisplay() {
            if (totalDataChunks === 0 && !fileNameData) {
                chunksDisplay.innerHTML = '<div style="text-align: center; color: #666; padding: 10px; width: 100%;">æš‚æ— åˆ†ç‰‡æ•°æ®</div>';
                return;
            }
            
            let html = '';
            
            // æ˜¾ç¤ºæ•°æ®åˆ†ç‰‡
            for (let i = 0; i < totalDataChunks; i++) {
                const isReceived = receivedDataChunks.has(i);
                html += `
                    <div class="chunk-item ${isReceived ? 'chunk-received' : 'chunk-missing'}" 
                         title="æ•°æ®åˆ†ç‰‡ ${i + 1}${isReceived ? ' (å·²æ¥æ”¶)' : ' (æœªæ¥æ”¶)'}">
                        ${i + 1}
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶ååˆ†ç‰‡
            if (fileNameData) {
                html += `
                    <div class="chunk-item chunk-filename" title="æ–‡ä»¶ååˆ†ç‰‡ (å·²æ¥æ”¶)">
                        ğŸ“„
                    </div>
                `;
            } else {
                html += `
                    <div class="chunk-item chunk-missing" title="æ–‡ä»¶ååˆ†ç‰‡ (æœªæ¥æ”¶)">
                        ğŸ“„
                    </div>
                `;
            }
            
            chunksDisplay.innerHTML = html;
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            status.textContent = message;
            status.className = 'status-message';
            if (type === 'success') status.classList.add('status-success');
            else if (type === 'error') status.classList.add('status-error');
            else status.classList.add('status-info');
        }

        // é‡ç»„æ–‡ä»¶
        assembleBtn.addEventListener('click', async () => {
            if (!fileNameData) {
                showStatus('âŒ ç¼ºå°‘æ–‡ä»¶åæ•°æ®', 'error');
                return;
            }
            
            if (receivedDataChunks.size < totalDataChunks) {
                const missing = totalDataChunks - receivedDataChunks.size;
                showStatus(`âŒ ç¼ºå°‘ ${missing} ä¸ªæ•°æ®åˆ†ç‰‡`, 'error');
                showFloatingMessage(`âŒ ç¼ºå°‘ ${missing} ä¸ªæ•°æ®åˆ†ç‰‡`, true);
                return;
            }
            
            try {
                assembleBtn.disabled = true;
                assembleBtnText.textContent = 'â³ é‡ç»„ä¸­...';
                showStatus('ğŸ› ï¸ æ­£åœ¨é‡ç»„æ–‡ä»¶...', 'info');
                
                // ç»„åˆæ‰€æœ‰æ•°æ®åˆ†ç‰‡
                let combinedBase64 = '';
                for (let i = 0; i < totalDataChunks; i++) {
                    const chunk = receivedDataChunks.get(i);
                    if (!chunk || !chunk.d) {
                        throw new Error(`âŒ ç¼ºå°‘æ•°æ®åˆ†ç‰‡ ${i+1}`);
                    }
                    combinedBase64 += chunk.d;
                }
                
                // è¡¥å…¨Base64
                while (combinedBase64.length % 4 !== 0) {
                    combinedBase64 += '=';
                }
                
                // Base64è§£ç 
                const binaryString = atob(combinedBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // è§£å‹ç¼©
                let decompressed;
                try {
                    decompressed = pako.inflate(bytes);
                } catch (decompressError) {
                    console.log('è§£å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ•°æ®:', decompressError);
                    decompressed = bytes;
                }
                
                // åˆ›å»ºBlob
                const blob = new Blob([decompressed]);
                const url = URL.createObjectURL(blob);
                
                // ä½¿ç”¨æ¥æ”¶åˆ°çš„æ–‡ä»¶å
                const finalFileName = receivedFileName;
                
                // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                fileName.textContent = finalFileName;
                fileSize.textContent = formatFileSize(decompressed.length);
                fileType.textContent = getFileTypeFromName(finalFileName);
                receiveTime.textContent = new Date().toLocaleString();
                fileInfo.style.display = 'block';
                downloadSection.classList.remove('hidden');
                
                // è®¾ç½®ä¸‹è½½æŒ‰é’®
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = finalFileName;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    showFloatingMessage('â¬‡ï¸ æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹');
                };
                
                showStatus('âœ… æ–‡ä»¶é‡ç»„å®Œæˆï¼ç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜æ–‡ä»¶', 'success');
                showFloatingMessage('ğŸ‰ æ–‡ä»¶é‡ç»„å®Œæˆï¼');
                assembleBtnText.textContent = 'âœ… é‡ç»„å®Œæˆ';
                
            } catch (err) {
                console.error('é‡ç»„å¤±è´¥:', err);
                showStatus('é‡ç»„å¤±è´¥: ' + err.message, 'error');
                showFloatingMessage('âŒ é‡ç»„å¤±è´¥', true);
                assembleBtn.disabled = false;
                assembleBtnText.textContent = 'ğŸ› ï¸ é‡ç»„æ–‡ä»¶';
            }
        });

        // æ¸…é™¤æ•°æ®
        clearBtn.addEventListener('click', async () => {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ¥æ”¶çš„æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å·²æ‰«æçš„åˆ†ç‰‡ã€‚')) {
                try {
                    await stopScanning();
                    
                    const store = localforage.createInstance({ name: 'qrcode-filename-separate' });
                    await store.clear();
                    
                    receivedDataChunks.clear();
                    fileNameData = null;
                    totalDataChunks = 0;
                    currentFileFingerprint = null;
                    receivedFileName = '';
                    receivedFileSize = 0;
                    currentFingerprint.style.display = 'none';
                    scanCount = 0;
                    
                    fileInfo.style.display = 'none';
                    downloadSection.classList.add('hidden');
                    assembleBtn.disabled = true;
                    assembleBtnText.textContent = 'ğŸ› ï¸ é‡ç»„æ–‡ä»¶';
					// é‡ç½®æ¥æ”¶æ—¶é—´æ˜¾ç¤º
            receiveTime.textContent = 'æœªçŸ¥';
                    
                    updateUI();
                    showStatus('å·²æ¸…é™¤æ‰€æœ‰æ•°æ®', 'info');
                    showFloatingMessage('ğŸ—‘ï¸ æ•°æ®å·²æ¸…é™¤');
                    
                } catch (err) {
                    console.error('æ¸…é™¤å¤±è´¥:', err);
                    showStatus('æ¸…é™¤å¤±è´¥: ' + err.message, 'error');
                }
            }
        });

        // å·¥å…·å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function getFileTypeFromName(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const types = {
                'txt': 'æ–‡æœ¬æ–‡æ¡£',
                'pdf': 'PDFæ–‡æ¡£',
                'jpg': 'JPEGå›¾ç‰‡',
                'jpeg': 'JPEGå›¾ç‰‡',
                'png': 'PNGå›¾ç‰‡',
                'gif': 'GIFå›¾ç‰‡',
                'zip': 'å‹ç¼©æ–‡ä»¶',
                'rar': 'å‹ç¼©æ–‡ä»¶',
                'doc': 'Wordæ–‡æ¡£',
                'docx': 'Wordæ–‡æ¡£',
                'xls': 'Excelæ–‡æ¡£',
                'xlsx': 'Excelæ–‡æ¡£',
                'ppt': 'PowerPointæ–‡æ¡£',
                'pptx': 'PowerPointæ–‡æ¡£',
                'mp3': 'éŸ³é¢‘æ–‡ä»¶',
                'mp4': 'è§†é¢‘æ–‡ä»¶',
                'avi': 'è§†é¢‘æ–‡ä»¶',
                'mov': 'è§†é¢‘æ–‡ä»¶',
                'js': 'JavaScriptæ–‡ä»¶',
                'html': 'ç½‘é¡µæ–‡ä»¶',
                'css': 'æ ·å¼è¡¨æ–‡ä»¶',
                'json': 'JSONæ–‡ä»¶'
            };
            return types[ext] || 'æœªçŸ¥ç±»å‹';
        }
    </script>
</body>
</html>